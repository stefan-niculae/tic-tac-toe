{"version":3,"sources":["../game.js"],"names":["NEED_TO_WIN","DISPLAY_SYMBOL","null","Game","constructor","size","root","elements","createGame","initializeState","values","emptyValues","nextPlayer","winner","history","appendStep","syncStatus","syncCells","state","i","row","Array","fill","push","createHistoryBoard","step","board","$","r","c","cell","value","text","append","click","truncatedHistory","slice","number","deepCopyArray","syncHistory","allCells","fillCell","message","player","status","rowElements","map","rowCells","activeSide","historyBoards","game","appendTo","height","css","col","currentValue","findWinner","gameOver","addClass","removeClass","highlightWhom","symbol","nSteps","length","boards","html","deltas","sums","transpose","diagonal","mirror","sum","reachedRequired","filter","Math","abs","console","assert","sign","gamesRoot"],"mappings":"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","file":"game.js","sourcesContent":["const NEED_TO_WIN = 3 // number of adjacent symbols needed to win\nconst DISPLAY_SYMBOL = {\n    // mapping from internal value to external display symbol\n    null: '' ,\n      1 : 'X',\n    '-1': 'O', // the letter O is more aesthetic than a zero\n}\n\nclass Game {\n    constructor(size, root) {\n        this.size = size\n        this.elements = this.createGame(root)\n\n        this.initializeState()\n    }\n\n    // Initialization\n    initializeState() {\n        this.values = this.emptyValues()\n        this.nextPlayer = +1  // X\n        this.winner = null\n\n        this.history = []\n        this.appendStep()\n\n        this.syncStatus()\n        this.syncCells()\n    }\n\n    emptyValues() {\n        let state = []\n        for (let i = 0; i < this.size; i++) {\n            let row = new Array(this.size).fill(null) // different one each time\n            state.push(row)\n        }\n        return state\n    }\n\n    createHistoryBoard(step) {\n        let board = $('<table>', {'class': 'board'})\n        for (let r = 0; r < this.size; r++) {\n            let row = $('<tr>')\n            for (let c = 0; c < this.size; c++) {\n                let cell = $('<td>')\n                let value = step.values[r][c]\n                cell.text(DISPLAY_SYMBOL[value])\n                row.append(cell)\n            }\n            board.append(row)\n        }\n\n        board.click(() => {\n            this.values = step.values\n            this.nextPlayer = step.nextPlayer\n            this.winner = step.winner\n\n            let truncatedHistory = this.history.slice(0, step.number + 1) // keep history up until this step\n            this.history = deepCopyArray(truncatedHistory)\n\n            this.syncStatus()\n            this.syncCells()\n            this.syncHistory()\n        })\n\n        return board\n    }\n\n    createGame(root) {\n        // create the cell objects\n        let allCells = []\n        for (let r = 0; r < this.size; r++) {\n            let row = []\n            for (let c = 0; c < this.size; c++) {\n                let cell = $('<td>', {\n                    'class': 'ripple',\n                    click: () => this.fillCell(r, c)\n                })\n                row.push(cell)\n            }\n            allCells.push(row)\n        }\n\n        // build and insert the elements into the DOM\n        let message = $('<span>', {'class': 'message'})\n        let player  = $('<span>', {'class': 'player'})\n        let status = $('<p>', {'class': 'status'})\n            .append(message)\n            .append(': ')\n            .append(player)\n\n        let rowElements = allCells.map(rowCells => $('<tr>').append(rowCells))\n        let board = $('<table>', {'class': 'board'}).append(rowElements)\n\n        let activeSide = $('<div>', {'class': 'active-side'})\n            .append(status)\n            .append(board)\n\n        let historyBoards = $('<div>', {'class': 'boards'})\n        let history = $('<div>', {'class': 'history'})\n            .append('<p>History</p>')\n            .append(historyBoards)\n\n        let game = $('<article>', {'class': 'game'})\n            .append(activeSide)\n            .append(history)\n            .appendTo(root)\n\n        // height is only evaluated after the element is inserted in the DOM\n        let height = activeSide.height()\n        history.css({height: height + 'px'})\n\n        return { allCells, game, message, player, historyBoards }\n    }\n\n    // Updating\n    fillCell(row, col) {\n        // do nothing if the game is over\n        if (this.winner !== null)\n            return\n\n        let currentValue = this.values[row][col]\n        // do nothing if the cell is already filled\n        if (currentValue !== null)\n            return\n\n        // update the internal values and reflect the changes\n        this.values[row][col] = this.nextPlayer // set current player\n        this.nextPlayer *= -1 // switch players\n        this.winner = this.findWinner()\n\n        this.syncCells() // show symbols and highlights\n        this.syncStatus() // show next player or winner\n\n        this.appendStep()\n    }\n\n    syncStatus() {\n        let gameOver = (this.winner !== null)\n        this.elements.message.text(gameOver ? 'Winner' : 'Next player')\n        this.elements.player.text(DISPLAY_SYMBOL[gameOver ? this.winner : this.nextPlayer])\n\n        if (gameOver)\n            this.elements.game.addClass('game-over')\n        else\n            this.elements.game.removeClass('game-over')\n    }\n    syncCells() {\n        // reflect changes in this.values into the DOM elements, accessed through this.cells\n        // and the next player\n\n        let highlightWhom = (this.winner === null) ?\n            this.nextPlayer : // highlight the next player if game in progress\n            this.winner       // if game over, highlight the winner\n\n        for (let r = 0; r < this.size; r++) {\n            for (let c = 0; c < this.size; c++) {\n                let value = this.values[r][c]\n                let cell = this.elements.allCells[r][c]\n\n                let symbol = DISPLAY_SYMBOL[value]\n                cell.text(symbol)\n\n                if (value === null) // empty cell and game is not over\n                    cell.removeClass('noninteractive')\n\n                if (value === highlightWhom)\n                    cell.addClass('highlighted')\n                else\n                    cell.removeClass('highlighted')\n            }\n        }\n    }\n\n    appendStep() {\n        let nSteps = this.history.length\n        this.history.push({\n            number: nSteps,\n            nextPlayer: this.nextPlayer,\n            values: deepCopyArray(this.values),\n            winner: this.winner,\n        })\n        this.syncHistory()\n    }\n    syncHistory() {\n        let game = this\n        let boards = this.history.map(step => game.createHistoryBoard(step))\n        this.elements.historyBoards.html(boards)\n    }\n\n\n    // Win condition\n    findWinner() {\n        for (let r = 0; r < this.size; r++) {\n            for (let c = 0; c < this.size; c++) {\n                let deltas = [\n                    [[-1,  0], [+1,  0]], // left, right\n                    [[ 0, -1], [ 0, +1]], // above, below\n                    [[-1, -1], [+1, +1]], // up-left, down-right\n                    [[+1, -1], [-1, +1]], // down-left, up-right\n                ]\n                // TODO\n            }\n        }\n\n        let sums = [\n            ...this.values,                // on each row\n            ...transpose(this.values),     // on each column\n            diagonal(this.values),         // on main diagonal\n            diagonal(mirror(this.values)), // on secondary diagonal\n        ].map(sum)\n\n        let reachedRequired = sums.filter(sum => Math.abs(sum) === NEED_TO_WIN)\n        if (reachedRequired.length === 0)\n            // no symbol reached the required number of occurrences to win\n            return null\n        else {\n            console.assert(reachedRequired.length === 1,\n                'There should be at most ONE symbol to reach the required number of occurrences', reachedRequired)\n            return Math.sign(reachedRequired[0]) // +1 for a sum of 3, -1 for a sum of -3\n        }\n    }\n\n}\n\nlet gamesRoot = $('#games')\nconst game = new Game(3, gamesRoot)\n"]}